name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npm run test
      - run: npm run build

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Build frontend
        run: cd frontend && npm ci && npm run build
      - uses: golangci/golangci-lint-action@v9

  backend:
    name: Backend
    runs-on: ubuntu-latest
    needs: [frontend, lint]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Build frontend
        run: cd frontend && npm ci && npm run build
      - name: Run tests
        run: go test ./...
      - name: Build binary
        run: go build -o dashyard .

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        run: cd frontend && npm ci
      - name: Build frontend
        run: cd frontend && npm run build
      - name: Install Playwright browsers
        run: cd frontend && npx playwright install chromium --with-deps
      - name: Start dummyprom
        run: go run ./cmd/dummyprom &
      - name: Start dummygithub
        run: go run ./cmd/dummygithub &
      - name: Start backend
        run: go run . serve --config examples/config-e2e.yaml &
      - name: Start Vite dev server
        run: cd frontend && npm run dev &
      - name: Wait for services
        run: |
          echo "Waiting for dummyprom on :9090..."
          timeout 30 bash -c 'until curl -sf http://localhost:9090/-/ready 2>/dev/null || curl -sf http://localhost:9090/api/v1/query?query=up 2>/dev/null; do sleep 1; done' || echo "dummyprom may be ready"
          echo "Waiting for dummygithub on :5555..."
          timeout 30 bash -c 'until curl -sf http://localhost:5555/api/v3/user 2>/dev/null; do sleep 1; done'
          echo "Waiting for backend on :8080..."
          timeout 30 bash -c 'until curl -so /dev/null http://localhost:8080/ 2>/dev/null; do sleep 1; done'
          echo "Waiting for Vite on :5173..."
          timeout 30 bash -c 'until curl -sf http://localhost:5173/ 2>/dev/null; do sleep 1; done'
      - name: Run Playwright tests
        run: cd frontend && npx playwright test
      - name: Upload Playwright report
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

  docker:
    name: Docker build
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    steps:
      - uses: actions/checkout@v6
      - run: docker build -t dashyard .
