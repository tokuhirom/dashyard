services:
  # --- Metrics storage ---
  prometheus:
    image: prom/prometheus:v3.4.0
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-remote-write-receiver
      - --storage.tsdb.retention.time=1h
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- OpenTelemetry Collector ---
  otelcol:
    image: otel/opentelemetry-collector-contrib:0.123.0
    volumes:
      - ./otelcol-config.yaml:/etc/otelcol/config.yaml:ro
    command: ["--config", "/etc/otelcol/config.yaml"]
    depends_on:
      prometheus:
        condition: service_healthy

  # --- HTTP proxy (Traefik v3) ---
  traefik:
    image: traefik:v3.4
    volumes:
      - ./traefik.yaml:/etc/traefik/traefik.yml:ro
      - ./traefik-dynamic.yaml:/etc/traefik/dynamic.yml:ro
    ports:
      - "8888:80"
    depends_on:
      - whoami

  # --- Simple backend for Traefik ---
  whoami:
    image: traefik/whoami

  # --- Redis ---
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # --- Traffic generator ---
  traffic-gen:
    image: alpine:3.20
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache wget >/dev/null 2>&1
        echo "Starting traffic generation..."
        while true; do
          wget -q -O /dev/null http://traefik:80/ 2>/dev/null
          wget -q -O /dev/null http://traefik:80/api 2>/dev/null
          wget -q -O /dev/null http://traefik:80/health 2>/dev/null
          redis-cli -h redis PING >/dev/null 2>&1 || true
          sleep 0.5
        done
    depends_on:
      - traefik
      - redis

  # --- Dashyard dashboard viewer ---
  dashyard:
    build:
      context: ../..
      dockerfile: Dockerfile
    volumes:
      - ./config.yaml:/etc/dashyard/config.yaml:ro
      - ./output/dashboards:/etc/dashyard/dashboards:ro
    ports:
      - "8080:8080"
    depends_on:
      prometheus:
        condition: service_healthy

  # --- gen-prompt tool (on-demand via profile) ---
  gen-prompt:
    build:
      context: ../..
      dockerfile: Dockerfile
    profiles: ["tools"]
    volumes:
      - ./output:/output
    entrypoint: ["/app/dashyard"]
    command:
      - gen-prompt
      - http://prometheus:9090
      - -o
      - /output
      - --force-prompt
    depends_on:
      prometheus:
        condition: service_healthy
